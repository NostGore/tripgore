<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRIPGORE</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Favicons -->
    <link rel="icon" href="https://files.catbox.moe/czvw1i.png" type="image/png">

    <!-- Graph -->
    <meta property="og:title" content="TRIPGORE | ¡Horror sin fin!">
    <meta property="og:description" content="Horror global gore, tu pagina segura.">
    <meta property="og:image" content="https://files.catbox.moe/cjmaz9.png">
    <meta property="og:url" content="https://tripgore.space">
    <meta property="og:type" content="website">

    <!-- tagm -->
    <meta name="monetag" content="583437fff63bc3cd76e7c597c20932d1">

    <script src="monetag/sw1.js"></script>
    <script src="monetag/sw2.js"></script>

    <script>(function (d, z, s) {s.src = 'https://' + d + '/401/' + z; try {(document.body || document.documentElement).appendChild(s)} catch (e) { } })('groleegni.net', 9394872, document.createElement('script'))</script>

    <script src="script.js"></script>
    <script src="function-scripts/menu.js"></script>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="https://files.catbox.moe/cjmaz9.png" alt="TRIPLEGORE" class="logo-img">
            </div>
            <nav class="nav">
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link"><i class="fa-solid fa-house"></i> Inicio</a></li>
                    <li><a href="adminpanel.html" class="nav-link"><i class="fa-solid fa-upload"></i> Subir</a></li>
                    <li><a href="chat.html" class="nav-link"><i class="fa-solid fa-comments"></i> Chat</a></li>

                    <li class="user-menu">
                        <span id="userDisplay" class="nav-link"><i class="fa-solid fa-user"></i> Invitado</span>
                        <div class="user-dropdown">
                            <a href="login.html" id="loginLink" class="dropdown-link">
                                <i class="fa-solid fa-sign-in-alt"></i> Iniciar Sesión
                            </a>
                            <a href="registro.html" id="registerLink" class="dropdown-link">
                                <i class="fa-solid fa-user-plus"></i> Registrarse
                            </a>
                            <a href="adminpanel.html" id="adminLink" class="dropdown-link" style="display: none;">
                                <i class="fa-solid fa-cogs"></i> Admin Panel
                            </a>
                            <a href="#" id="logoutLink" class="dropdown-link" style="display: none;">
                                <i class="fa-solid fa-sign-out-alt"></i> Cerrar Sesión
                            </a>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- SECCIÓN RECOMENDADOS -->
            <p>ㅤPaciencia, espera que cargue los videos.</p>
            <p>ㅤ</p>
            <section class="section">
                <h2 class="section-title">RECOMENDADOS</h2>
                <div class="content-grid" id="recomendados-grid">
                    <!-- Los videos recomendados se cargarán aquí -->
                </div>
            </section>

            <!-- SECCIÓN 1 -->
            <section class="section">
                <h2 class="section-title">ASESINATOS</h2>
                <div class="content-grid" data-category="ASESINATOS">
                    <!-- Videos se cargarán aquí -->
                </div>
            </section>

            <!-- SECCIÓN 2 -->
            <section class="section">
                <h2 class="section-title">ACCIDENTES</h2>
                <div class="content-grid" data-category="ACCIDENTES">
                    <!-- Videos se cargarán aquí -->
                </div>
            </section>

            <!-- SECCIÓN 3 -->
            <section class="section">
                <h2 class="section-title">INCIDENTES</h2>
                <div class="content-grid" data-category="INCIDENTES">
                    <!-- Videos se cargarán aquí -->
                </div>
            </section>

            <!-- SECCIÓN 4 -->
            <section class="section">
                <h2 class="section-title">SUICIDIOS</h2>
                <div class="content-grid" data-category="SUICIDIOS">
                    <!-- Videos se cargarán aquí -->
                </div>
            </section>

            <!-- SECCIÓN 5 -->
            <section class="section">
                <h2 class="section-title">AUTOLESIONES</h2>
                <div class="content-grid" data-category="AUTOLESIONES">
                    <!-- Videos se cargarán aquí -->
                </div>
            </section>
        </div>
    </main>
    <script type="module">
        import {authFunctions, updateUserDisplay, videoFunctions} from './function-scripts/firebase.js';
        import mediaDB from './mediaDB.js';
        import './function-scripts/search.js';

        // Make videoFunctions globally available for search
        window.videoFunctions = videoFunctions;

        document.addEventListener('DOMContentLoaded', async function () {
            // Wait for auth state to be determined
            await updateUserDisplay();

            loadRecommendedVideos();
            loadApprovedVideos();

            // Function to load recommended videos from mediaDB
            function loadRecommendedVideos() {
                const recommendedContainer = document.querySelector('.recommended-videos .videos-grid');
                if (!recommendedContainer) return;

                // Filter videos that have content (not empty)
                const validVideos = mediaDB.filter(video =>
                    video.titulo && video.portada && video.video && video.autor && video.categoria
                );

                // Get random 6 videos for recommendations
                const shuffled = validVideos.sort(() => 0.5 - Math.random());
                const recommendedVideos = shuffled.slice(0, 6);

                recommendedContainer.innerHTML = '';

                // Function to generate URL-friendly ID from title
                function generateVideoId(title) {
                    return title
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '') // Remove emojis and special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-') // Replace multiple hyphens with single
                        .trim()
                        .replace(/^-+|-+$/g, '') // Remove leading/trailing hyphens
                        .replace(/[^a-z0-9]*$/g, ''); // Remove all trailing non-alphanumeric characters
                }

                recommendedVideos.forEach((video, index) => {
                    const videoCard = document.createElement('div');
                    videoCard.className = 'content-card';
                    videoCard.innerHTML = `
                        <img src="${video.portada}" alt="${video.titulo}" class="content-image"
                             onerror="this.src='https://via.placeholder.com/300x180/8B0000/FFFFFF?text=Error+Imagen'">
                        <div class="content-overlay">
                            <i class="fa-solid fa-play"></i>
                        </div>
                        <div class="content-info">
                            <h3 class="content-title">${video.titulo}</h3>
                            <div class="content-meta">
                                <i class="fa-solid fa-user"></i>
                                ${video.autor}
                            </div>
                          <div class="content-meta">
                                <i class="fa-solid fa-tags"></i>
                                ${video.categoria}
                            </div>
                        </div>
                    `;

                    videoCard.addEventListener('click', () => {
                        // Generate URL-friendly ID from title
                        const videoIdUrl = generateVideoId(video.titulo);
                        window.location.href = `video.html?id=${videoIdUrl}`;
                    });

                    recommendedContainer.appendChild(videoCard);
                });
            }

            // Function to load approved videos from mediaDB
            function loadApprovedVideos() {
                const videosContainer = document.querySelector('.category-videos .videos-grid');
                if (!videosContainer) return;

                // Filter videos that have content (not empty)
                const validVideos = mediaDB.filter(video =>
                    video.titulo && video.portada && video.video && video.autor && video.categoria
                );

                videosContainer.innerHTML = '';

                // Function to generate URL-friendly ID from title
                function generateVideoId(title) {
                    return title
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '') // Remove emojis and special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-') // Replace multiple hyphens with single
                        .trim()
                        .replace(/^-+|-+$/g, '') // Remove leading/trailing hyphens
                        .replace(/[^a-z0-9]*$/g, ''); // Remove all trailing non-alphanumeric characters
                }

                validVideos.forEach((video, index) => {
                    const videoCard = document.createElement('div');
                    videoCard.className = 'content-card';
                    videoCard.innerHTML = `
                        <img src="${video.portada}" alt="${video.titulo}" class="content-image"
                             onerror="this.src='https://via.placeholder.com/300x180/8B0000/FFFFFF?text=Error+Imagen'">
                        <div class="content-info">
                            <h3>${video.titulo}</h3>
                            <div class="content-meta">
                                <i class="fa-solid fa-user"></i>
                                Por: ${video.autor}
                            </div>
                            <div class="content-meta">
                                <i class="fa-solid fa-tags"></i>
                                ${video.categoria}
                            </div>
                        </div>
                    `;

                    videoCard.addEventListener('click', () => {
                        // Generate URL-friendly ID from title
                        const videoIdUrl = generateVideoId(video.titulo);
                        window.location.href = `video.html?id=${videoIdUrl}`;
                    });

                    videosContainer.appendChild(videoCard);
                });
            }

            const loginLink = document.getElementById('loginLink');
            const registerLink = document.getElementById('registerLink');
            const adminLink = document.getElementById('adminLink');
            const logoutLink = document.getElementById('logoutLink');

            // Listen for auth state changes
            authFunctions.onAuthStateChanged((user) => {
                if (user) {
                    // User is logged in
                    loginLink.style.display = 'none';
                    registerLink.style.display = 'none';
                    adminLink.style.display = 'block';
                    logoutLink.style.display = 'block';

                    // User is logged in - moderation features available
                } else {
                    // User is logged out
                    loginLink.style.display = 'block';
                    registerLink.style.display = 'block';
                    adminLink.style.display = 'none';
                    logoutLink.style.display = 'none';
                }
            });

            function loadRecommendedVideos() {
                const recomendadosGrid = document.getElementById('recomendados-grid');
                if (!recomendadosGrid) return;

                // Mostrar animación de carga
                showLoadingAnimation(recomendadosGrid);

                // Filter valid videos from mediaDB
                const validVideos = mediaDB.filter(video =>
                    video.titulo && video.portada && video.video && video.autor && video.categoria
                );

                if (validVideos.length === 0) {
                    recomendadosGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; color: #FFB6C1; padding: 40px;">
                            <i class="fa-solid fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>No hay videos disponibles para mostrar</p>
                        </div>
                    `;
                    return;
                }

                // Shuffle and take 8 random videos
                const shuffled = validVideos.sort(() => 0.5 - Math.random());
                const recommendedVideos = shuffled.slice(0, 8);

                recomendadosGrid.innerHTML = '';

                // Function to generate URL-friendly ID from title
                function generateVideoId(title) {
                    return title
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '') // Remove emojis and special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-') // Replace multiple hyphens with single
                        .trim()
                        .replace(/^-+|-+$/g, '') // Remove leading/trailing hyphens
                        .replace(/[^a-z0-9]*$/g, ''); // Remove all trailing non-alphanumeric characters
                }

                recommendedVideos.forEach((video, index) => {
                    const videoCard = document.createElement('div');
                    videoCard.className = 'content-card';
                    videoCard.style.cursor = 'pointer';
                    videoCard.innerHTML = `
                        <div class="card-image-container">
                            <img src="${video.portada}" alt="${video.titulo}" class="card-image" 
                                 onerror="this.src='https://via.placeholder.com/300x180/8B0000/FFFFFF?text=Error+Imagen'">
                            <div class="card-stats">
                                <div class="stat-item">
                                    <i class="fa-solid fa-thumbs-up"></i>
                                    <span class="likes-count" data-video-id="${video.id}">0</span>
                                </div>
                                <div class="stat-item">
                                    <i class="fa-solid fa-comment"></i>
                                    <span class="comments-count" data-video-id="${video.id}">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-overlay">
                            <i class="fa-solid fa-play"></i>
                        </div>
                        <div class="card-content">
                            <h4>${video.titulo}</h4>
                            <div class="card-info">
                                <p class="card-author"><i class="fa-solid fa-user"></i> Autor: ${video.autor}</p>
                                <p class="card-date"><i class="fa-solid fa-calendar-day"></i> Subido: ${video.fecha}</p>
                            </div>
                        </div>
                    `;

                    videoCard.addEventListener('click', () => {
                        window.location.href = `video.html?id=${video.id}`;
                    });

                    // Load stats for this video
                    loadVideoStats(video.id);

                    recomendadosGrid.appendChild(videoCard);
                });
            }

            function loadApprovedVideos() {
                const categories = ['ASESINATOS', 'ACCIDENTES', 'INCIDENTES', 'SUICIDIOS', 'AUTOLESIONES'];

                // Mostrar animación de carga para todas las categorías
                categories.forEach(category => {
                    const contentGrid = document.querySelector(`[data-category="${category}"]`);
                    if (contentGrid) {
                        showLoadingAnimation(contentGrid);
                    }
                });

                // Filter videos from mediaDB by category
                categories.forEach(category => {
                    const validVideos = mediaDB.filter(video =>
                        video.titulo && video.portada && video.video && video.autor && video.categoria &&
                        video.categoria.toUpperCase().includes(category)
                    );
                    updateCategorySection(category, validVideos);
                });
            }



            function showLoadingAnimation(contentGrid) {
                contentGrid.innerHTML = `
                    <div class="loading-container" style="grid-column: 1 / -1; text-align: center; color: #FFB6C1; padding: 40px;">
                        <div class="loading-spinner">
                            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 48px; margin-bottom: 20px; color: #DC143C;"></i>
                        </div>
                        <p style="font-size: 18px; margin-bottom: 10px;">Espere, cargando videos...</p>
                        <div class="loading-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </div>
                    </div>
                `;
            }

            function updateCategorySection(category, videos) {
                const sections = document.querySelectorAll('.section');
                let targetSection = null;

                sections.forEach(section => {
                    const title = section.querySelector('.section-title');
                    if (title && title.textContent.trim() === category) {
                        targetSection = section;
                    }
                });

                if (!targetSection) return;

                const contentGrid = targetSection.querySelector('.content-grid');
                if (!contentGrid) return;

                if (videos.length === 0) {
                    contentGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; color: #FFB6C1; padding: 40px;">
                            <i class="fa-solid fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>No hay videos aprobados en esta categoría</p>
                        </div>
                    `;
                    return;
                }

                // Limpiar contenido previo
                contentGrid.innerHTML = '';

                // Remover botón "Ver más" previo si existe
                const existingBtn = targetSection.querySelector('.show-more-btn');
                if (existingBtn) {
                    existingBtn.remove();
                }

                // Mostrar solo los primeros 4 videos inicialmente
                const initialVideos = videos.slice(0, 4);
                const remainingVideos = videos.slice(4);

                // Crear y agregar los primeros 4 videos
                initialVideos.forEach(video => {
                    const videoCard = createVideoCard(video);
                    contentGrid.appendChild(videoCard);
                });

                // Si hay más de 4 videos, crear el botón "Ver más" en el título
                if (remainingVideos.length > 0) {
                    const sectionTitle = targetSection.querySelector('.section-title');
                    const showMoreBtn = document.createElement('button');
                    showMoreBtn.className = 'show-more-btn';
                    showMoreBtn.innerHTML = `
                        &#43; ${remainingVideos.length}
                    `;

                    let isExpanded = false;

                    showMoreBtn.addEventListener('click', () => {
                        if (!isExpanded) {
                            // Mostrar todos los videos restantes
                            remainingVideos.forEach(video => {
                                const videoCard = createVideoCard(video);
                                contentGrid.appendChild(videoCard);
                            });
                            showMoreBtn.innerHTML = `&#8722; Menos`;
                            showMoreBtn.classList.add('hide-btn');
                            isExpanded = true;
                        } else {
                            // Ocultar videos adicionales
                            const allCards = contentGrid.querySelectorAll('.content-card');
                            for (let i = 4; i < allCards.length; i++) {
                                allCards[i].remove();
                            }
                            showMoreBtn.innerHTML = `&#43; ${remainingVideos.length}`;
                            showMoreBtn.classList.remove('hide-btn');
                            isExpanded = false;
                        }
                    });

                    sectionTitle.appendChild(showMoreBtn);
                }
            }

            function createVideoCard(video) {
                // Use the ID from the database directly
                const videoIdUrl = video.id;
                const actualIndex = mediaDB.indexOf(video);
                const videoCard = document.createElement('div');
                videoCard.className = 'content-card';
                videoCard.style.cursor = 'pointer';
                videoCard.innerHTML = `
                    <div class="card-image-container">
                        <img src="${video.portada}" alt="${video.titulo}" class="card-image" 
                             onerror="this.src='https://via.placeholder.com/300x180/8B0000/FFFFFF?text=Error+Imagen'">
                        <div class="card-stats">
                            <div class="stat-item">
                                <i class="fa-solid fa-thumbs-up"></i>
                                <span class="likes-count" data-video-id="${videoIdUrl}">0</span>
                            </div>
                            <div class="stat-item">
                                <i class="fa-solid fa-comment"></i>
                                <span class="comments-count" data-video-id="${videoIdUrl}">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-overlay">
                        <i class="fa-solid fa-play"></i>
                    </div>
                    <div class="card-content">
                        <h4>${video.titulo}</h4>
                        <div class="card-info">
                            <p class="card-author"><i class="fa-solid fa-user"></i> Autor: ${video.autor}</p>
                            <p class="card-date"><i class="fa-solid fa-calendar-day"></i> Subido: ${video.fecha}</p>
                        </div>
                    </div>
                `;

                videoCard.addEventListener('click', () => {
                    window.location.href = `video.html?id=${videoIdUrl}`;
                });

                // Load stats for this video
                loadVideoStats(videoIdUrl);

                return videoCard;
            }

            // Sistema de animación del último mensaje del chat
            function initLastMessageAnimation() {
                const lastMessageAnimation = document.getElementById('lastMessageAnimation');
                const lastMessageText = document.querySelector('.last-message-text');
                const lastMessageAuthor = document.querySelector('.last-message-author');

                if (!lastMessageAnimation) return;

                let lastShownMessageId = localStorage.getItem('lastShownChatMessage');

                // Importar Firebase modules
                import('./function-scripts/firebase.js').then(({getDatabase, ref, onValue, query, orderByChild, limitToLast}) => {
                    const realtimeDb = getDatabase();
                    const messagesRef = ref(realtimeDb, 'chat_messages');
                    const lastMessageQuery = query(messagesRef, orderByChild('timestamp'), limitToLast(1));

                    onValue(lastMessageQuery, (snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            const message = childSnapshot.val();
                            const messageId = childSnapshot.key;

                            // Solo mostrar si es un mensaje nuevo y diferente al último mostrado
                            if (messageId !== lastShownMessageId && message && message.text) {
                                setTimeout(() => {
                                    showLastMessage(message, messageId);
                                }, 1000);
                            }
                        });
                    });
                }).catch(error => {
                    console.log('Firebase no disponible para animación de mensajes:', error);
                });

                function showLastMessage(message, messageId) {
                    if (lastMessageText && lastMessageAuthor) {
                        lastMessageText.textContent = message.text;
                        lastMessageAuthor.textContent = `- ${message.author}`;

                        lastMessageAnimation.classList.remove('hide');
                        lastMessageAnimation.classList.add('show');
                        lastMessageAnimation.style.display = 'block';

                        localStorage.setItem('lastShownChatMessage', messageId);

                        // Ocultar después de 5 segundos
                        setTimeout(() => {
                            hideLastMessage();
                        }, 5000);
                    }
                }

                function hideLastMessage() {
                    lastMessageAnimation.classList.remove('show');
                    lastMessageAnimation.classList.add('hide');

                    setTimeout(() => {
                        lastMessageAnimation.style.display = 'none';
                        lastMessageAnimation.classList.remove('hide');
                    }, 500);
                }

                // Click en la animación lleva al chat
                lastMessageAnimation.addEventListener('click', () => {
                    window.location.href = 'chat.html';
                });

                // Verificar cada 20 segundos si hay mensajes nuevos
                setInterval(() => {
                    // Este intervalo actúa como backup, la lógica principal está en el listener de Firebase
                }, 20000);
            }

            // Inicializar la animación solo si estamos en la página de inicio
            if (window.location.pathname.endsWith('index.html') || window.location.pathname === '/') {
                // Esperar a que se cargue Firebase
                setTimeout(() => {
                    initLastMessageAnimation();
                }, 2000);
            }

            // Inicializar funcionalidad del footer
            initFooter();

            function initFooter() {
                // Cargar contador total de videos
                loadTotalVideoCount();

                // Configurar botón de scroll hacia arriba
                const scrollToTopBtn = document.getElementById('scrollToTop');
                if (scrollToTopBtn) {
                    scrollToTopBtn.addEventListener('click', () => {
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    });

                    // Mostrar/ocultar botón según scroll
                    window.addEventListener('scroll', () => {
                        if (window.pageYOffset > 300) {
                            scrollToTopBtn.style.opacity = '1';
                            scrollToTopBtn.style.visibility = 'visible';
                        } else {
                            scrollToTopBtn.style.opacity = '0';
                            scrollToTopBtn.style.visibility = 'hidden';
                        }
                    });

                    // Inicialmente oculto
                    scrollToTopBtn.style.opacity = '0';
                    scrollToTopBtn.style.visibility = 'hidden';
                    scrollToTopBtn.style.transition = 'all 0.3s ease';
                }
            }

            function loadTotalVideoCount() {
                const totalVideoCountElement = document.getElementById('totalVideoCount');
                if (!totalVideoCountElement) return;

                const validVideos = mediaDB.filter(video =>
                    video.titulo && video.portada && video.video && video.autor && video.categoria
                );
                totalVideoCountElement.textContent = validVideos.length;
            }

            // Function to load video stats (likes and comments)
            function loadVideoStats(videoId) {
                // Load likes count
                videoFunctions.getLikes(videoId, (likesData) => {
                    const likesElement = document.querySelector(`[data-video-id="${videoId}"].likes-count`);
                    if (likesElement) {
                        likesElement.textContent = likesData.likes.length;
                    }
                });

                // Load comments count
                videoFunctions.getComments(videoId, (comments) => {
                    const commentsElement = document.querySelector(`[data-video-id="${videoId}"].comments-count`);
                    if (commentsElement) {
                        commentsElement.textContent = comments.length;
                    }
                });
            }
        });
    </script>

    <!-- Animación del último mensaje del chat -->
    <div id="lastMessageAnimation" class="last-message-animation" style="display: none;">
        <div class="last-message-content">
            <i class="fa-solid fa-comments"></i>
            <span class="last-message-text"></span>
            <div class="last-message-author"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="https://files.catbox.moe/cjmaz9.png" alt="TRIPGORE" class="footer-logo-img">
                </div>

                <div class="footer-info">
                    <p class="copyright">
                        <i class="fa-solid fa-copyright"></i>
                        ©
                        <script
                            type='text/javascript'>var creditsyear = new Date(); document.write(creditsyear.getFullYear());</script>
                        TRIPGORE. Todos los derechos reservados.
                    </p>

                    <p class="video-count">
                        <i class="fa-solid fa-video"></i>
                        Videos totales: <span id="totalVideoCount">0</span>
                    </p>

                    <p class="security-message">
                        <i class="fa-solid fa-shield-halved"></i>
                        Esta página es completamente segura
                    </p>
                </div>

                <div class="footer-scroll">
                    <button id="scrollToTop" class="scroll-to-top">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <script type="module" src="function-scripts/modal.js"></script>

</body>

</html>